<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Synthesis and HLS Backend - Calyx Documentation</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../intro.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../fud/index.html"><strong aria-hidden="true">2.</strong> fud: The Calyx Driver</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../fud/examples.html"><strong aria-hidden="true">2.1.</strong> Examples</a></li><li class="chapter-item expanded "><a href="../fud/synthesis.html" class="active"><strong aria-hidden="true">2.2.</strong> Synthesis and HLS Backend</a></li><li class="chapter-item expanded "><a href="../fud/external.html"><strong aria-hidden="true">2.3.</strong> External Stages</a></li><li class="chapter-item expanded "><a href="../fud/multiple-paths.html"><strong aria-hidden="true">2.4.</strong> Multiple Paths</a></li><li class="chapter-item expanded "><a href="../fud/circt.html"><strong aria-hidden="true">2.5.</strong> CIRCT</a></li></ol></li><li class="chapter-item expanded "><a href="../compiler.html"><strong aria-hidden="true">3.</strong> The Calyx Compiler</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../libraries/core.html"><strong aria-hidden="true">3.1.</strong> Primitive Library</a></li></ol></li><li class="chapter-item expanded "><a href="../interpreter.html"><strong aria-hidden="true">4.</strong> The Calyx Interpreter</a></li><li class="chapter-item expanded "><a href="../tools/index.html"><strong aria-hidden="true">5.</strong> Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tools/runt.html"><strong aria-hidden="true">5.1.</strong> Runt</a></li><li class="chapter-item expanded "><a href="../tools/exp-generator.html"><strong aria-hidden="true">5.2.</strong> exp Generator</a></li><li class="chapter-item expanded "><a href="../tools/editor-highlighting.html"><strong aria-hidden="true">5.3.</strong> Editor Highlighting</a></li></ol></li><li class="chapter-item expanded "><a href="../tutorial/language-tut.html"><strong aria-hidden="true">6.</strong> Language Tutorial</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../lang/multi-component.html"><strong aria-hidden="true">6.1.</strong> Multi-Component Designs</a></li><li class="chapter-item expanded "><a href="../lang/memories-by-reference.html"><strong aria-hidden="true">6.2.</strong> Passing Memories by Reference</a></li><li class="chapter-item expanded "><a href="../lang/attributes.html"><strong aria-hidden="true">6.3.</strong> Attributes</a></li></ol></li><li class="chapter-item expanded "><a href="../calyx-py.html"><strong aria-hidden="true">7.</strong> Emitting Calyx from Python</a></li><li class="chapter-item expanded "><a href="../tutorial/frontend-tut.html"><strong aria-hidden="true">8.</strong> Frontend Tutorial</a></li><li class="chapter-item expanded "><a href="../frontends/index.html"><strong aria-hidden="true">9.</strong> Frontend Compilers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../frontends/dahlia.html"><strong aria-hidden="true">9.1.</strong> Dahlia</a></li><li class="chapter-item expanded "><a href="../frontends/systolic-array.html"><strong aria-hidden="true">9.2.</strong> Systolic Array Generator</a></li><li class="chapter-item expanded "><a href="../frontends/tvm-relay.html"><strong aria-hidden="true">9.3.</strong> TVM Relay</a></li><li class="chapter-item expanded "><a href="../frontends/ntt.html"><strong aria-hidden="true">9.4.</strong> NTT Pipeline Generator</a></li><li class="chapter-item expanded "><a href="../frontends/mrxl.html"><strong aria-hidden="true">9.5.</strong> MrXL</a></li></ol></li><li class="chapter-item expanded "><a href="../optimizations/index.html"><strong aria-hidden="true">10.</strong> Optimizations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../optimizations/dataflow.html"><strong aria-hidden="true">10.1.</strong> Dataflow Analysis</a></li></ol></li><li class="chapter-item expanded "><a href="../debug/debug.html"><strong aria-hidden="true">11.</strong> Debugging Tips</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../contributors.html">Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Calyx Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="xilinx-toolchain"><a class="header" href="#xilinx-toolchain">Xilinx Toolchain</a></h1>
<blockquote>
<p>Working with vendor EDA toolchains is never a fun experience. Something will
almost certainly go wrong. If you're at Cornell, you can at least avoid
installing the tools yourself by using our lab servers, <a href="https://capra.cs.cornell.edu/private/gorgonzola.html">Gorgonzola</a> or <a href="https://capra.cs.cornell.edu/private/havarti.html">Havarti</a>.</p>
</blockquote>
<p><code>fud</code> can interact with the Xilinx tools (<a href="https://www.xilinx.com/products/design-tools/vivado.html">Vivado</a>, <a href="https://www.xilinx.com/products/design-tools/vivado/integration/esl-design.html">Vivado HLS</a>, and <a href="https://www.xilinx.com/products/design-tools/vitis/vitis-platform.html">Vitis</a>). There are three main things it can do:</p>
<ul>
<li>Synthesize Calyx-generated RTL designs to collect area and resource estimates.</li>
<li>Compile <a href="https://capra.cs.cornell.edu/dahlia/">Dahlia</a> programs via C++ and <a href="https://www.xilinx.com/products/design-tools/vivado/integration/esl-design.html">Vivado HLS</a> for comparison with the Calyx backend.</li>
<li>Compile Calyx programs for <em>actual execution</em> in Xilinx emulation modes or on real FPGA hardware.</li>
</ul>
<p>You can set <code>fud</code> up to use either a local installation of the Xilinx tools or one on a remote server, via SSH.</p>
<h2 id="synthesis-only"><a class="header" href="#synthesis-only">Synthesis Only</a></h2>
<p>The simplest way to use the Xilinx tools is to synthesize RTL or HLS designs to collect statistics about them.
This route will not produce actual, runnable executables; see the next section for that.</p>
<h3 id="set-up"><a class="header" href="#set-up">Set Up</a></h3>
<p>To set up to <strong>invoke the Xilinx tools over SSH</strong>, first tell <code>fud</code> your username and hostname for the server:</p>
<pre><code># Vivado
fud config stages.synth-verilog.ssh_host &lt;hostname&gt;
fud config stages.synth-verilog.ssh_username &lt;username&gt;
fud config stages.synth-verilog.remote true

# Vivado HLS
fud config stages.vivado-hls.ssh_host &lt;hostname&gt;
fud config stages.vivado-hls.ssh_username &lt;username&gt;
fud config stages.vivado-hls.remote true
</code></pre>
<p>The server must have <code>vivado</code> and <code>vivado_hls</code> available on the remote machine's path. (If you need the executable names to be something else, please file an issue.)</p>
<p>To instead <strong>invoke the Xilinx tools locally</strong>, just let <code>fud</code> run the <code>vivado</code> and <code>vivado_hls</code> commands.
You can optionally tell <code>fud</code> where these commands exist on your machine:</p>
<pre><code>fud config stages.synth-verilog.exec &lt;path&gt; # update vivado path
fud config stages.vivado-hls.exec &lt;path&gt; # update vivado_hls path
</code></pre>
<p>Leave the <code>remote</code> option unset to use local execution and these <code>exec</code> paths (which are ignored for remote execution).</p>
<h3 id="run"><a class="header" href="#run">Run</a></h3>
<p>To run the entire toolchain and extract statistics from RTL synthesis, use the <code>resource-estimate</code> target state.
For example:</p>
<pre><code>fud e --to resource-estimate examples/futil/dot-product.futil
</code></pre>
<p>To instead obtain the raw synthesis results, use <code>synth-files</code>.</p>
<p>To run the analogous toolchain for Dahlia programs via HLS, use the <code>hls-estimate</code> target state:</p>
<pre><code>fud e --to hls-estimate examples/dahlia/dot-product.fuse
</code></pre>
<p>There is also an <code>hls-files</code> state for the raw results of Vivado HLS.</p>
<h2 id="emulation-and-execution"><a class="header" href="#emulation-and-execution">Emulation and Execution</a></h2>
<p><code>fud</code> can also compile Calyx programs for actual execution, either in the Xilinx toolchain's emulation modes or for running on a physical FPGA.
This route involves generating an <a href="https://en.wikipedia.org/wiki/Advanced_eXtensible_Interface">AXI</a> interface wrapper for the Calyx program and invoking it using <a href="https://xilinx.github.io/XRT/">XRT</a>'s OpenCL interface.</p>
<h3 id="set-up-1"><a class="header" href="#set-up-1">Set Up</a></h3>
<p>As above, you can invoke the Xilinx toolchain locally or remotely, via SSH.
To set up SSH execution, you can edit your <code>config.toml</code> to add settings like this:</p>
<pre><code>[stages.xclbin]
ssh_host = &quot;havarti&quot;
ssh_username = &quot;als485&quot;
remote = true
</code></pre>
<p>To use local execution, just leave off the <code>remote = true</code> line.</p>
<p>You can also set the Xilinx mode and target device:</p>
<pre><code>[stages.xclbin]
mode = &quot;hw_emu&quot;
device = &quot;xilinx_u50_gen3x16_xdma_201920_3&quot;
</code></pre>
<p>The options for <code>mode</code> are <code>hw_emu</code> (simulation) and <code>hw</code> (on-FPGA execution).
The device string above is for the <a href="https://www.xilinx.com/products/boards-and-kits/alveo/u50.html">Alveo U50</a> card, which we have at Cornell, but I honestly don't know how you're supposed to find the right string for a different FPGA target.
Hopefully someone will figure this out and document it in the future.</p>
<h3 id="compile"><a class="header" href="#compile">Compile</a></h3>
<p>The first step in the Xilinx toolchain is to generate <a href="https://xilinx.github.io/XRT/2021.2/html/formats.html#xclbin">an <code>xclbin</code> executable file</a>.
Here's an example of going all the way from a Calyx program to that:</p>
<pre><code>fud e examples/futil/dot-product.futil -o foo.xclbin
</code></pre>
<p>On our machines, compiling even a simple example like the above for simulation takes about 5 minutes, end to end.
A failed run takes about 2 minutes to produce an error.</p>
<p>By default, the Xilinx tools run in a temporary directory that is deleted when <code>fud</code> finishes.
To instead keep the sandbox directory, use <code>-s xclbin.save_temps true</code>.
You can then find the results in a directory named <code>fud-out-N</code> for some number <code>N</code>.</p>
<h3 id="how-it-works"><a class="header" href="#how-it-works">How it Works</a></h3>
<p>The first step is to generate input files.
We need to generate:</p>
<ul>
<li>The RTL for the design itself, using the compile command-line flags <code>-b verilog --synthesis -p external</code>. We name this file <code>main.sv</code>.</li>
<li>A Verilog interface wrapper, using <code>XilinxInterfaceBackend</code>, via <code>-b xilinx</code>. We call this <code>toplevel.v</code>.</li>
<li>An XML document describing the interface, using <code>XilinxXmlBackend</code>, via <code>-b xilinx-xml</code>. This file gets named <code>kernel.xml</code>.</li>
</ul>
<p>We also use <a href="https://github.com/cucapra/calyx/blob/master/fud/bitstream/gen_xo.tcl">a static Tcl script, <code>gen_xo.tcl</code>,</a> to drive the Xilinx tools.
The <code>fud</code> driver gathers these files together in a sandbox directory.
Then, the Xilinx toolchain's first step is to compile the Verilog to a <code>.xo</code> file, which is a Xilinx analog of a <code>.o</code> object file.
The Vivado command line looks roughly like this:</p>
<pre><code>vivado -mode batch -source gen_xo.tcl -tclargs xclbin/kernel.xo kernel hw_emu xilinx_u50_gen3x16_xdma_201920_3
</code></pre>
<p>Those arguments after <code>-tclargs</code>, unsurprisingly, get passed to <a href="https://github.com/cucapra/calyx/blob/master/fud/bitstream/gen_xo.tcl"><code>gen_xo.tcl</code></a>.</p>
<p>Then, we take this <code>.xo</code> and turn it into an <a href="https://xilinx.github.io/XRT/2021.2/html/formats.html#xclbin"><code>.xclbin</code></a>, in a step that is Xilinx's analog of &quot;linking&quot; an executable.
This step uses the <code>v++</code> tool, with a command line that looks like this:</p>
<pre><code>v++ -g -t hw_emu --platform xilinx_u50_gen3x16_xdma_201920_3 --save-temps --profile.data all:all:all --profile.exec all:all:all -lo xclbin/kernel.xclbin xclbin/kernel.xo
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../fud/examples.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../fud/external.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../fud/examples.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../fud/external.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
