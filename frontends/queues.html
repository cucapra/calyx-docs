<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Queues - Calyx Documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../intro.html">Getting Started</a></li><li class="chapter-item expanded affix "><li class="part-title">Calyx Language</li><li class="chapter-item expanded "><a href="../tutorial/language-tut.html"><strong aria-hidden="true">1.</strong> Language Tutorial</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../lang/multi-component.html"><strong aria-hidden="true">1.1.</strong> Multi-Component Designs</a></li><li class="chapter-item expanded "><a href="../lang/memories-by-reference.html"><strong aria-hidden="true">1.2.</strong> Passing Memories by Reference</a></li></ol></li><li class="chapter-item expanded "><a href="../lang/ref.html"><strong aria-hidden="true">2.</strong> Language Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../lang/data-format.html"><strong aria-hidden="true">2.1.</strong> Data Format</a></li><li class="chapter-item expanded "><a href="../lang/static.html"><strong aria-hidden="true">2.2.</strong> Static Timing</a></li><li class="chapter-item expanded "><a href="../lang/sync.html"><strong aria-hidden="true">2.3.</strong> Experimental: Synchronization</a></li><li class="chapter-item expanded "><a href="../lang/undefined.html"><strong aria-hidden="true">2.4.</strong> Undefined Behaviors</a></li></ol></li><li class="chapter-item expanded "><a href="../lang/attributes.html"><strong aria-hidden="true">3.</strong> Attributes</a></li><li class="chapter-item expanded affix "><li class="part-title">Running Calyx Programs</li><li class="chapter-item expanded "><a href="../running-calyx/fud/index.html"><strong aria-hidden="true">4.</strong> fud: The Calyx Driver</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../running-calyx/fud/examples.html"><strong aria-hidden="true">4.1.</strong> Examples</a></li><li class="chapter-item expanded "><a href="../running-calyx/fud/xilinx.html"><strong aria-hidden="true">4.2.</strong> Xilinx Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../running-calyx/fud/axi-gen.html"><strong aria-hidden="true">4.2.1.</strong> AXI Generation</a></li></ol></li><li class="chapter-item expanded "><a href="../running-calyx/fud/external.html"><strong aria-hidden="true">4.3.</strong> External Stages</a></li><li class="chapter-item expanded "><a href="../running-calyx/fud/multiple-paths.html"><strong aria-hidden="true">4.4.</strong> Multiple Paths</a></li><li class="chapter-item expanded "><a href="../running-calyx/fud/circt.html"><strong aria-hidden="true">4.5.</strong> CIRCT</a></li><li class="chapter-item expanded "><a href="../running-calyx/fud/resource-estimation.html"><strong aria-hidden="true">4.6.</strong> Resource Estimation</a></li></ol></li><li class="chapter-item expanded "><a href="../running-calyx/fud2/index.html"><strong aria-hidden="true">5.</strong> fud2: Experimental Driver</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../running-calyx/fud2/scripts.html"><strong aria-hidden="true">5.1.</strong> Scripting</a></li></ol></li><li class="chapter-item expanded "><a href="../running-calyx/interfacing.html"><strong aria-hidden="true">6.</strong> Interfacing with Calyx RTL</a></li><li class="chapter-item expanded "><a href="../running-calyx/interpreter.html"><strong aria-hidden="true">7.</strong> The Calyx Interpreter</a></li><li class="chapter-item expanded affix "><li class="part-title">Compiler Development Guide</li><li class="chapter-item expanded "><a href="../compiler.html"><strong aria-hidden="true">8.</strong> The Calyx Compiler</a></li><li class="chapter-item expanded "><a href="../new-pass.html"><strong aria-hidden="true">9.</strong> Adding a New Pass</a></li><li class="chapter-item expanded "><a href="../libraries/core.html"><strong aria-hidden="true">10.</strong> Primitive Library</a></li><li class="chapter-item expanded "><a href="../compiler-as-library.html"><strong aria-hidden="true">11.</strong> The calyx Library</a></li><li class="chapter-item expanded "><a href="../optimizations/dataflow.html"><strong aria-hidden="true">12.</strong> Dataflow Analysis</a></li><li class="chapter-item expanded "><a href="../debug/index.html"><strong aria-hidden="true">13.</strong> Debugging</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../debug/cider.html"><strong aria-hidden="true">13.1.</strong> Logical Bugs</a></li><li class="chapter-item expanded "><a href="../debug/debug.html"><strong aria-hidden="true">13.2.</strong> Compilation Bugs</a></li></ol></li><li class="chapter-item expanded "><a href="../github.html"><strong aria-hidden="true">14.</strong> Contributing to Calyx</a></li><li class="chapter-item expanded affix "><li class="part-title">Generating Calyx</li><li class="chapter-item expanded "><a href="../builder/calyx-py.html"><strong aria-hidden="true">15.</strong> Emitting Calyx from Python</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../builder/walkthrough.html"><strong aria-hidden="true">15.1.</strong> Builder Library Walkthrough</a></li></ol></li><li class="chapter-item expanded "><a href="../tutorial/frontend-tut.html"><strong aria-hidden="true">16.</strong> Frontend Tutorial</a></li><li class="chapter-item expanded "><a href="../frontends/index.html"><strong aria-hidden="true">17.</strong> Frontend Compilers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../frontends/dahlia.html"><strong aria-hidden="true">17.1.</strong> Dahlia</a></li><li class="chapter-item expanded "><a href="../frontends/systolic-array.html"><strong aria-hidden="true">17.2.</strong> Systolic Array Generator</a></li><li class="chapter-item expanded "><a href="../frontends/tvm-relay.html"><strong aria-hidden="true">17.3.</strong> TVM Relay</a></li><li class="chapter-item expanded "><a href="../frontends/ntt.html"><strong aria-hidden="true">17.4.</strong> NTT Pipeline Generator</a></li><li class="chapter-item expanded "><a href="../frontends/queues.html" class="active"><strong aria-hidden="true">17.5.</strong> Queues</a></li><li class="chapter-item expanded "><a href="../frontends/mrxl.html"><strong aria-hidden="true">17.6.</strong> MrXL</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Tools</li><li class="chapter-item expanded "><a href="../tools/runt.html"><strong aria-hidden="true">18.</strong> Runt</a></li><li class="chapter-item expanded "><a href="../tools/data-gen.html"><strong aria-hidden="true">19.</strong> Data Gen</a></li><li class="chapter-item expanded "><a href="../tools/exp-generator.html"><strong aria-hidden="true">20.</strong> exp Generator</a></li><li class="chapter-item expanded "><a href="../tools/editor-highlighting.html"><strong aria-hidden="true">21.</strong> Editor Highlighting</a></li><li class="chapter-item expanded "><a href="../tools/language-server.html"><strong aria-hidden="true">22.</strong> Language Server</a></li><li class="chapter-item expanded affix "><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../contributors.html">Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Calyx Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="queues"><a class="header" href="#queues">Queues</a></h1>
<p>A queue is a standard data structure that maintains a set of elements in some total order.
A new element is added to the queue using the <code>enqueue</code> operation, which is also known as <code>push</code> or <code>insert</code> in some contexts.
Because of the total order, some element of the queue is the <em>most favorably ranked</em> element.
We can remove this element from the queue using the <code>dequeue</code> operation, which is also known as <code>pop</code> or <code>remove</code> in some contexts.</p>
<p>We provision four types of queues in Calyx. The first three follow the same shared interface, while the fourth follows a slightly extended interface.
The frontend is implemented using the <a href="../builder/calyx-py.html">Calyx builder library</a>, and the source code is heavily commented.</p>
<p>We first describe the shared interface and their associated testing harness and then detail the four types of queues.</p>
<h2 id="shared-interface"><a class="header" href="#shared-interface">Shared Interface</a></h2>
<p>All queues in Calyx expose the same interface.</p>
<ul>
<li>Input port <code>cmd</code>, a 2-bit integer.
Selects the operation to perform:
<ul>
<li><code>0</code>: <code>pop</code>.</li>
<li><code>1</code>: <code>push</code>.</li>
</ul>
</li>
<li>Input port <code>value</code>, a 32-bit integer.
The value to push.</li>
<li>Register <code>ans</code>, a 32-bit integer that is passed to the queue by reference.
If <code>pop</code> is selected, the queue writes the result to this register.</li>
<li>Register <code>err</code>, a 1-bit integer that is passed to the queue by reference.
The queue raises this flag in case of overflow or underflow.</li>
</ul>
<h2 id="shared-testing-harness"><a class="header" href="#shared-testing-harness">Shared Testing Harness</a></h2>
<p>Because they expose a common interface, we can test all queues using the same harness.</p>
<h4 id="data-generation"><a class="header" href="#data-generation">Data Generation</a></h4>
<p>First, we have a Python module that generates randomized sequences of operations and values, and dumps the sequences out in a Calyx <code>.data</code> file.
It accepts as a command line argument the number of operations to generate.
It also takes a flag, <code>--no-err</code>, that generates a special sequence of operations that does not trigger any overflow or underflow errors.
If this flag is provided, the queue's length must also be provided.
The Python code is in <a href="https://github.com/calyxir/calyx/blob/main/calyx-py/calyx/queue_data_gen.py"><code>queue_data_gen.py</code></a>.</p>
<h4 id="oracles"><a class="header" href="#oracles">Oracles</a></h4>
<p>Next, we have a Python module <em>for each kind of queue</em> that reads the <code>.data</code> file, simulates the queue in Python, and dumps the expected result out in a Calyx <code>.expect</code> file.
This Python code is aware of our <a href="#shared-interface">shared interface</a>.
The oracles are in <a href="https://github.com/calyxir/calyx/blob/main/calyx-py/calyx/fifo_oracle.py"><code>fifo_oracle.py</code></a>, <a href="https://github.com/calyxir/calyx/blob/main/calyx-py/calyx/pifo_oracle.py"><code>pifo_oracle.py</code></a>, <a href="https://github.com/calyxir/calyx/blob/main/calyx-py/calyx/pifo_tree_oracle.py"><code>pifo_tree_oracle.py</code></a>, and <a href="https://github.com/calyxir/calyx/blob/main/calyx-py/calyx/binheap_oracle.py"><code>binheap_oracle.py</code></a>.
They all appeal to pure-Python implementations of the queues, which are found in <a href="https://github.com/calyxir/calyx/blob/main/calyx-py/calyx/queues.py"><code>queues.py</code></a>.
Each oracle also requires, as command line arguments, the number of operations being simulated and the queue's length.</p>
<h4 id="queue-call"><a class="header" href="#queue-call">Queue Call</a></h4>
<p>The steps above lay out <code>.data</code> and <code>.expect</code> files for our Calyx code.
To actually pass a series of commands to a given eDSL queue implementation, we need to call the queue repeatedly with memories parsed from the <code>.data</code> file.
Unlike the above, which happens at the pure Python level, this needs to happen at the eDSL level.</p>
<p>This is exactly what <a href="https://github.com/calyxir/calyx/blob/main/calyx-py/calyx/queue_call.py"><code>queue_call.py</code></a> does.
It accepts as a Python-level argument a handle to the queue component that is to be tested.
It inserts a <code>main</code> component that reads the <code>.data</code> file and calls the queue component repeatedly.
If a command-line flag, <code>--keepgoing</code>, is provided, the <code>main</code> component will ignore any overflow or underflow errors raised by the queue component and will complete the entire sequence of operations.
If not, the <code>main</code> component will stop after the queue component first raises an error.</p>
<h4 id="putting-it-all-together"><a class="header" href="#putting-it-all-together">Putting It All Together</a></h4>
<p>The testing harness can be executed, for all our queues, by running the shell script <a href="https://github.com/calyxir/calyx/blob/main/calyx-py/calyx/gen_queue_data_expect.sh"><code>gen_queue_data_expect.sh</code></a>.
This generates the <code>.data</code> and <code>.expect</code> files for each queue.</p>
<p>Then, each queue can be tested using our <code>runt</code> setup.
The queue-generating Python files themselves expect command-line arguments (the number of operations and the optional <code>--keepgoing</code> flag) and you can see these being passed in the <a href="https://github.com/calyxir/calyx/blob/a4c2442675d3419be6d2f5cf912aa3f804b3c4ab/runt.toml#L131-L144">relevant <code>runt</code> stanza</a>.</p>
<h2 id="fifo"><a class="header" href="#fifo">FIFO</a></h2>
<p>The most basic queue is the <em>first in, first out</em> (FIFO) queue: the most favorably ranked element is just the one that was added to the queue first.</p>
<p>Our queue frontend generates a simple FIFO in Calyx.
The source code is available <a href="https://github.com/calyxir/calyx/blob/main/calyx-py/test/correctness/queues/fifo.py">here</a>.</p>
<p>Internally, our FIFO queue is implemented as a circular buffer.
One register marks the next element that would be popped, another marks the next cell into which an element would be pushed, and a third marks the number of elements in the queue.
The control logic is straightforward, and proceeds in three parallel arms based on the operation requested.</p>
<p>Using a circular buffer usually entails incrementing indices modulo the buffer size.
We use a trick to avoid this: we require the FIFO's length to be a power of two, say <code>2^k</code>, and we use adders of width <code>k</code> to increment the indices.
This means we can just naively increment the indices forever and the wrap-around behavior we want is automatically provided by overflow.</p>
<h2 id="specialized-pifos"><a class="header" href="#specialized-pifos">Specialized PIFOs</a></h2>
<p>A more complex instance is the priority queue.
At time of enqueue, an element is associated with a priority.
The most favorably ranked element is the one with the highest priority.
Two elements may be pushed with the same priority; a priority queue that is additionally defined to break such ties in FIFO order is called a <em>push in, first out</em> (PIFO) queue.</p>
<p>We provide PIFOs in the general sense (i.e., queues that accept <code>(item, rank)</code> pairs and enqueue based on <code>rank</code>) <a href="#minimum-binary-heap">shortly</a>. For now, let's focus on specialized PIFOs that have a policy "baked in" to the queue itself.</p>
<p>We have two types of specialized PIFOs - Round Robin and Strict - that implement policies which determine which flow to pop from next. These PIFOs are parameterized over the number of flows, <code>n</code>, that they can arbitrate between.</p>
<h3 id="round-robin-queues"><a class="header" href="#round-robin-queues">Round-Robin Queues</a></h3>
<p>Round robin queues are PIFOs generalized to <code>n</code> flows that operate in a work
conserving round-robin fashion. That is, if a flow is silent when it is its turn, that flow
simply skips its turn and the next flow is offered service.</p>
<p>Internally, it operates <code>n</code> subqueues.
It takes in a list <code>boundaries</code> that must be of length <code>n</code>, using which the
client can divide the incoming traffic into <code>n</code> flows.
For example, if <code>n = 3</code> and the client passes boundaries <code>[133, 266, 400]</code>,
packets will be divided into three flows according to the intervals: <code>[0, 133]</code>, <code>[134, 266]</code>, <code>[267, 400]</code>.</p>
<ul>
<li>At <code>push</code>, we check the <code>boundaries</code> list to determine which flow to push to.
Take the boundaries example given earlier, <code>[133, 266, 400]</code>.
If we push the value <code>89</code>, it will, under the hood, be pushed into subqueue 0 becuase <code>0 &lt;= 89 &lt;= 133</code>,
and <code>305</code> will be pushed into subqueue 2 since <code>266 &lt;= 305 &lt;= 400</code>.</li>
<li>The program maintains a <code>hot</code> pointer that starts off at 0, meaning the next subqueue to pop from is queue 0.
At <code>pop</code> we first try to pop from <code>hot</code>. If this succeeds, great. If it fails,
we increment <code>hot</code> and therefore continue to check all other flows
in round robin fashion.</li>
</ul>
<p>The source code is available in <a href="https://github.com/calyxir/calyx/blob/main/calyx-py/test/correctness/queues/strict_and_rr_queues/gen_strict_or_rr.py"><code>gen_strict_or_rr.py</code></a>, which takes as arguments <code>n</code>, <code>boundaries</code>, and handles to the subqueues it must administer. It also takes a boolean parameter <code>round_robin</code>, which, if <code>true</code>, results in the generation of a round-robin queue.</p>
<h3 id="strict-queues"><a class="header" href="#strict-queues">Strict Queues</a></h3>
<p>Strict queues support <code>n</code> flows as well, but instead, flows have a strict order of priority and this which determines popping
order. That is, the second-highest priority subqueue will only be allowed to pop if the highest priority subqueue is empty.
If the higher-priority flow get pushed to in the interim, the next call to <code>pop</code> will again try to pop from the highest priority flow.</p>
<p>Like round-robin queues, it takes in a list <code>boundaries</code> that must be of length <code>n</code>, which divide the incoming traffic into <code>n</code> flows.
For example, if <code>n = 3</code> and the client passes boundaries <code>[133, 266, 400]</code>,
packets will be divided into three flows according to the intervals: <code>[0, 133]</code>, <code>[134, 266]</code>, <code>[267, 400]</code>.</p>
<p>It takes a list <code>order</code> that must be of length <code>n</code>, which specifies the order
of priority of the flows. For example, if <code>n = 3</code> and the client passes order
<code>[1, 2, 0]</code>, then flow 1 (packets in range <code>[134, 266]</code>) has first priority, flow 2
(packets in range <code>[267, 400]</code>) has second priority, and flow 0 (packets in range
<code>[0, 133]</code>) has last priority.</p>
<ul>
<li>At push, we check the <code>boundaries</code> list to determine which flow to push to.
Take the boundaries example given earlier, <code>[133, 266, 400]</code>.
If we push the value <code>89</code>, it will, under the hood, be pushed into subqueue 0 becuase <code>0 &lt;= 89 &lt;= 133</code>,
and <code>305</code> will be pushed into subqueue 2 since <code>266 &lt;= 305 &lt;= 400</code>.</li>
<li>Pop first tries to pop from <code>order[0]</code>. If this succeeds, great. If it fails, it tries <code>order[1]</code>, and so on.</li>
</ul>
<p>The source code is available in <a href="https://github.com/calyxir/calyx/blob/main/calyx-py/test/correctness/queues/strict_and_rr_queues/gen_strict_or_rr.py"><code>gen_strict_or_rr.py</code></a>, which takes as arguments <code>n</code>, <code>boundaries</code>, <code>order</code>, and handles to the subqueues it must administer. It also takes a boolean parameter <code>round_robin</code>, which, if <code>false</code>, results in the generation of a strict queue.</p>
<h2 id="pifo-tree"><a class="header" href="#pifo-tree">PIFO Tree</a></h2>
<p>A PIFO tree is a tree-shaped data structure in which each node is associated with a PIFO.
The PIFO tree stores elements in its leaf PIFOs and scheduling metadata in its internal nodes.</p>
<p>Pushing a new element into a PIFO tree involves putting the element into a leaf PIFO and putting additional metadata into internal nodes from the root to the leaf.
A variety of scheduling policies can be realized by manipulating the various priorities with which this data is inserted into each PIFO.
Popping the most favorably ranked element from a PIFO tree is relatively straightforward: popping the root PIFO tells us which child PIFO to pop from next, and we recurse until we reach a leaf PIFO.
We refer interested readers to <a href="https://dl.acm.org/doi/10.1145/2934872.2934899">this</a> research paper for more details on PIFO trees.</p>
<p>Our frontend allows for the creation of PIFO trees of any height, number of children, and with
the scheduling policy at each internal node being <em>round-robin</em> or <em>strict</em>.</p>
<p>See the <a href="https://github.com/calyxir/calyx/blob/main/calyx-py/test/correctness/queues/pifo_tree.py">source code</a> for an example where we create a PIFO tree of height 2.
Specifically, the example implements the PIFO tree described in §2 of <a href="https://dl.acm.org/doi/10.1145/3622845">this</a> research paper.</p>
<p>Internally, our PIFO tree is implemented by leveraging the PIFO frontend.
The PIFO frontend seeks to orchestrate two queues, which in the simple case will just be two FIFOs.
However, it is easy to generalize those two queues: instead of being FIFOs, they can be PIFOs or even PIFO trees.</p>
<p>We see a more complex example of a PIFO tree in [<code>complex_tree.py</code>] <a href="https://github.com/calyxir/calyx/blob/main/calyx-py/test/correctness/queues/complex_tree.py">complex_tree.py</a>. This tree does round robin between three children, two of which are strict queues and the other is a round robin queue. This tree has a height of 3. The overall structure is <code>rr(strict(A, B, C), rr(D, E, F), strict(G, H))</code>.</p>
<h2 id="minimum-binary-heap"><a class="header" href="#minimum-binary-heap">Minimum Binary Heap</a></h2>
<p>A minimum binary heap is another tree-shaped data structure where each node has at most two children.
However, unlike the queues discussed above, a heap exposes an extended interface:
in addition to the input ports and reference registers discussed above, a heap has an additional input <code>rank</code>.
The <code>push</code> operation now accepts both a <code>value</code> and the <code>rank</code> that the user wishes to associate with that value.
Consequently, a heap <em>orders</em> its elements by <code>rank</code>, with the <code>pop</code> operation set to remove the element with minimal rank.</p>
<p>To maintain this ordering efficiently, a heap stores <code>(rank, value)</code> pairs in each node and takes special care to maintain the following invariant:</p>
<blockquote>
<p><strong>Min-Heap Property</strong>: for any given node <code>C</code>, if <code>P</code> is a parent of <code>C</code>, then the rank of <code>P</code> is less than or equal to the rank of <code>C</code>.</p>
</blockquote>
<p>To <code>push</code> or <code>pop</code> an element is easy at the top level: write to or read from the correct node, and then massage the tree to restore the Min-Heap Property.
The <code>push</code> and <code>pop</code> operations are logarithmic in the size of the heap.</p>
<p>Our frontend allows for the creation of minimum binary heaps in Calyx; the source code is available in <a href="https://github.com/calyxir/calyx/blob/main/calyx-py/test/correctness/queues/binheap/binheap.py"><code>binheap.py</code></a>.</p>
<p>One quirk of any minimum binary heap is its ambiguous behavior in the case of rank ties.
More specifically, if the value <code>a</code> is pushed with some rank, and then later value <code>b</code> is pushed with the same rank, it's unclear which will be popped first.
Often, it's desirable to break such ties in FIFO order: that is we'd like a guarantee that <code>a</code> will be popped first.
A binary heap that provides this guarantee is called a <em>stable binary heap</em>, and our frontend provides a thin layer over our heap that enforces this property.</p>
<p>Our <code>stable_binheap</code> is a heap accepting 32-bit ranks and values.
It uses a counter <code>i</code> and instantiates, in turn, a binary heap that accepts 64-bit ranks and 32-bit values.</p>
<ul>
<li>To push a pair <code>(r, v)</code> into <code>stable_binheap</code>, we craft a new 64-bit rank that incorporates the counter <code>i</code> (specifically, we compute <code>r &lt;&lt; 32 + i</code>), and we push <code>v</code> into our underlying binary heap with this new 64-bit rank. We also increment the counter <code>i</code>.</li>
<li>To pop <code>stable_binheap</code>, we pop the underlying binary heap.</li>
</ul>
<p>The source code is available in <a href="https://github.com/calyxir/calyx/blob/main/calyx-py/test/correctness/queues/binheap/stable_binheap.py"><code>stable_binheap.py</code></a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../frontends/ntt.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../frontends/mrxl.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../frontends/ntt.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../frontends/mrxl.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
